#!/bin/sh
# Pre-publish hook for npm publish
# This ensures code is properly built before publishing

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

error() {
  echo "${RED}✖ $1${NC}" >&2
}

info() {
  echo "${GREEN}ℹ $1${NC}"
}

warning() {
  echo "${YELLOW}⚠ $1${NC}" >&2
}

info "Running pre-publish verification..."

# Check if dist directory exists
if [ ! -d "dist" ]; then
  error "dist directory not found. Running build..."
  npm run build || {
    error "Build failed. Cannot publish."
    exit 1
  }
fi

# Verify bin file exists
if [ ! -f "dist/cli/index.js" ]; then
  error "CLI bin file not found at dist/cli/index.js"
  error "Build may have failed. Checking..."
  npm run build || {
    error "Build failed. Cannot publish."
    exit 1
  }
  
  # Check again after build
  if [ ! -f "dist/cli/index.js" ]; then
    error "CLI bin file still not found after build."
    error "Please check build configuration."
    exit 1
  fi
fi

# Run linting
info "Running linter..."
npm run lint || {
  error "Linting failed. Cannot publish."
  exit 1
}

# Run type check
info "Running TypeScript type check..."
npm run type-check || {
  error "Type check failed. Cannot publish."
  exit 1
}

# Run tests
info "Running tests..."
npm test || {
  warning "Tests failed. Consider fixing before publishing."
  error "Publish cancelled. Fix tests before publishing."
  exit 1
}

# Verify package.json bin points to correct file
BIN_PATH=$(node -e "console.log(require('./package.json').bin.scaffel)")
if [ "$BIN_PATH" != "./dist/cli/index.js" ]; then
  error "package.json bin path mismatch. Expected: ./dist/cli/index.js, Got: $BIN_PATH"
  exit 1
fi

info "✓ Pre-publish verification passed"
info "Ready to publish!"

